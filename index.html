<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-CS-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lese-Lern-App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Font: Playwrite DE Grund -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playwrite+DE+Grund:wght@100..400&display=swap" rel="stylesheet">
    
    <style>
        /* Wende die Grundschrift auf die gesamte App an */
        body {
            font-family: 'Playwrite DE Grund', cursive;
        }

        /* Verstecke die Scrollleiste im Wort-Container, aber erlaube das Scrollen (als Fallback) */
        #wort-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        #wort-container {
            -ms-overflow-style: none;  /* IE und Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Benutzerdefinierte Stile für Checkboxen, damit sie besser aussehen */
        .buchstaben-input {
            width: 1.5rem;
            height: 1.5rem;
            accent-color: #3b82f6; /* Blau */
        }
        
        /* Stellt sicher, dass der App-Container die Höhe des Viewports nutzt,
           besonders auf Mobilgeräten wichtig, um die Buttons nach unten zu schieben. */
        html, body {
            height: 100%;
            overflow: hidden; /* Verhindert Bouncing auf Mobilgeräten */
        }
        #app-container {
            height: 100vh; /* Nutzt die volle Viewport-Höhe */
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white flex items-center justify-center p-4">

    <!-- Haupt-Container der App -->
    <div id="app-container" class="w-full max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">

        <!-- 1. Startbildschirm (Einstellungen) -->
        <div id="startbildschirm" class="p-6 md:p-8 flex flex-col h-full">
            <h1 class="text-3xl font-bold text-center text-blue-600 dark:text-blue-400 mb-6">Lese-App</h1>
            
            <form id="einstellungs-form" class="flex-grow flex flex-col overflow-y-auto">
                
                <div class="flex-grow space-y-6">
                    <!-- Buchstabenauswahl -->
                    <div>
                        <label class="block text-lg font-semibold mb-3">Gelernte Buchstaben:</label>
                        <div id="buchstaben-container" class="grid grid-cols-5 sm:grid-cols-6 gap-4">
                            <!-- Checkboxen werden hier per JS eingefügt -->
                        </div>
                    </div>

                    <!-- Weitere Einstellungen -->
                    <div class="space-y-4">
                        <div>
                            <label for="min-silben" class="block text-lg font-semibold mb-2">Minimale Silben:</label>
                            <input type="number" id="min-silben" value="2" min="1" max="5" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-lg">
                        </div>

                        <div>
                            <label for="max-silben" class="block text-lg font-semibold mb-2">Maximale Silben:</label>
                            <input type="number" id="max-silben" value="3" min="1" max="5" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-lg">
                        </div>
                        
                        <div>
                            <label for="worte-pro-runde" class="block text-lg font-semibold mb-2">Wörter pro Runde:</label>
                            <input type="number" id="worte-pro-runde" value="10" min="1" max="50" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-lg">
                        </div>

                        <!-- Silbenfärbung -->
                        <div class="flex items-center justify-between mt-4">
                            <label for="silben-faerben" class="text-lg font-semibold">Silben abwechselnd einfärben:</label>
                            <input type="checkbox" id="silben-faerben" checked class="buchstaben-input">
                        </div>

                        <div class="flex items-center justify-between mt-4">
                            <label for="silben-abstand" class="text-lg font-semibold">Silbenabstand anzeigen:</label>
                            <input type="checkbox" id="silben-abstand" class="buchstaben-input"> <!-- Standard ist 'unchecked' (aus) -->
                        </div>
                    </div>
                </div>

                <!-- Start Button -->
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-2xl py-4 px-6 rounded-xl shadow-lg transition duration-200 mt-8">
                    Start!
                </button>
            </form>
        </div>

        <!-- 2. Spielbildschirm -->
        <!-- START ÄNDERUNG: "relative" hinzugefügt, damit das Icon positioniert werden kann -->
        <div id="spiel" class="hidden p-6 md:p-8 flex flex-col h-full relative">
            
            <!-- START ÄNDERUNG: Burger-Menü-Button hinzugefügt -->
            <button id="einstellungen-button" class="absolute top-6 right-6 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition duration-200 z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-8 6h8" />
                </svg>
            </button>
            <!-- END ÄNDERUNG -->

            <!-- Wort-Anzeige (Oberes Drittel) -->
            <div class="flex-shrink-0 flex items-center justify-center min-h-[40vh]">
                <div id="wort-container" class="text-center font-bold whitespace-nowrap overflow-x-auto" style="font-size: 4.5rem; line-height: 1.2;">
                    <!-- Wort wird hier per JS eingefügt -->
                </div>
            </div>

            <!-- Spacer (schiebt Buttons nach unten) -->
            <div class="flex-grow"></div>

            <!-- Spiel-Buttons (Unteres Drittel) -->
            <div id="spiel-buttons" class="flex flex-col md:flex-row gap-4 justify-center flex-shrink-0">
                <button id="richtig-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-200 text-xl w-full">
                    Richtig gelesen
                </button>
                <button id="ueberspringen-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-200 text-xl w-full">
                    Überspringen
                </button>
            </div>
        </div>

        <!-- 3. Auswertungsbildschirm -->
        <div id="auswertung" class="hidden p-6 md:p-8 flex flex-col h-full justify-between">
            <h2 class="text-3xl font-bold text-center text-blue-600 dark:text-blue-400">Super!</h2>
            
            <div class="text-center my-8">
                <p class="text-xl mb-4">Deine Bewertung:</p>
                <div id="sterne-bewertung" class="text-5xl text-yellow-400 text-center">
                    <!-- Sterne werden hier per JS eingefügt -->
                </div>
            </div>

            <button id="zurueck-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-2xl py-4 px-6 rounded-xl shadow-lg transition duration-200">
                Zurück zum Menü
            </button>
        </div>

    </div>


    <script>
        // --- Konstanten ---
        const VOKAL_LISTE = ['A', 'E', 'I', 'O', 'U'];
        const KONSONANT_LISTE = ['B', 'D', 'F', 'G', 'H', 'K', 'L', 'M', 'N', 'P', 'R', 'S', 'T', 'W'];
        const DIPHTHONGE_LISTE = ['EI', 'AU', 'EU'];
        const ALLE_BUCHSTABEN = [...VOKAL_LISTE, ...KONSONANT_LISTE, ...DIPHTHONGE_LISTE].sort();

        // --- Globaler State ---
        const state = {
            gelernteBuchstaben: [],
            vokale: [],
            konsonanten: [],
            diphthonge: [],
            minSilben: 2,
            maxSilben: 3,
            worteProRunde: 10,
            aktuellesWortIndex: 0,
            richtigGezählt: 0,
            aktuellesWort: [], 
            silbenFaerben: true,
            silbenAbstand: false,
            gezeigteWorte: []
        };

        // --- DOM-Elemente ---
        const startbildschirm = document.getElementById('startbildschirm');
        const spiel = document.getElementById('spiel');
        const auswertung = document.getElementById('auswertung');
        
        const startForm = document.getElementById('einstellungs-form');
        const buchstabenContainer = document.getElementById('buchstaben-container');
        const minSilbenInput = document.getElementById('min-silben');
        const maxSilbenInput = document.getElementById('max-silben');
        const worteProRundeInput = document.getElementById('worte-pro-runde');
        const silbenFaerbenCheckbox = document.getElementById('silben-faerben');
        const silbenAbstandCheckbox = document.getElementById('silben-abstand');
        
        const wortContainer = document.getElementById('wort-container');
        const richtigButton = document.getElementById('richtig-button');
        const ueberspringenButton = document.getElementById('ueberspringen-button');
        const einstellungenButton = document.getElementById('einstellungen-button'); // START ÄNDERUNG
        
        const sterneBewertung = document.getElementById('sterne-bewertung');
        const zurueckButton = document.getElementById('zurueck-button');

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', init);
        startForm.addEventListener('submit', zeigeSpiel);
        richtigButton.addEventListener('click', () => handleWort(true));
        ueberspringenButton.addEventListener('click', () => handleWort(false));
        zurueckButton.addEventListener('click', zeigeStartbildschirm);
        einstellungenButton.addEventListener('click', zeigeStartbildschirm); // START ÄNDERUNG
        
        window.addEventListener('resize', () => {
            if (spiel.classList.contains('hidden')) return;
            adjustFontSize();
        });


        // --- Initialisierung ---
        function init() {
            // Einstellungen laden
            const geladeneEinstellungen = loadSettings();
            let standardBuchstaben = ['A', 'M', 'O', 'L', 'I'];
            let standardSilbenFaerben = true;
            let standardSilbenAbstand = false;
            let standardMinSilben = "2";
            let standardMaxSilben = "3";
            
            if (geladeneEinstellungen) {
                standardBuchstaben = geladeneEinstellungen.buchstaben || standardBuchstaben;
                standardMinSilben = geladeneEinstellungen.minSilben || "2";
                standardMaxSilben = geladeneEinstellungen.maxSilben || "3";
                worteProRundeInput.value = geladeneEinstellungen.worteProRunde || "10";
                if (geladeneEinstellungen.silbenFaerben !== undefined) {
                    standardSilbenFaerben = geladeneEinstellungen.silbenFaerben;
                }
                if (geladeneEinstellungen.silbenAbstand !== undefined) {
                    standardSilbenAbstand = geladeneEinstellungen.silbenAbstand;
                }
            }
            
            minSilbenInput.value = standardMinSilben;
            maxSilbenInput.value = standardMaxSilben;
            silbenFaerbenCheckbox.checked = standardSilbenFaerben;
            silbenAbstandCheckbox.checked = standardSilbenAbstand;

            // Buchstaben-Checkboxen erstellen
            buchstabenContainer.innerHTML = '';
            ALLE_BUCHSTABEN.forEach(b => {
                const id = `cb-${b}`;
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = id;
                input.value = b;
                input.className = 'buchstaben-input';
                if (standardBuchstaben.includes(b)) {
                    input.checked = true;
                }
                
                const label = document.createElement('label');
                label.htmlFor = id;
                label.textContent = b;
                label.className = 'text-lg font-medium';
                
                div.appendChild(input);
                div.appendChild(label);
                buchstabenContainer.appendChild(div);
            });
        }

        // --- LocalStorage Funktionen ---
        function saveSettings() {
            try {
                const settings = {
                    buchstaben: state.gelernteBuchstaben,
                    minSilben: minSilbenInput.value,
                    maxSilben: maxSilbenInput.value,
                    worteProRunde: worteProRundeInput.value,
                    silbenFaerben: silbenFaerbenCheckbox.checked,
                    silbenAbstand: silbenAbstandCheckbox.checked
                };
                localStorage.setItem('leseAppEinstellungen', JSON.stringify(settings));
            } catch (e) {
                console.warn("LocalStorage ist nicht verfügbar oder voll:", e);
            }
        }

        function loadSettings() {
            try {
                const settingsString = localStorage.getItem('leseAppEinstellungen');
                if (settingsString) {
                    return JSON.parse(settingsString);
                }
            } catch (e) {
                console.warn("Fehler beim Laden der Einstellungen aus LocalStorage:", e);
            }
            return null;
        }

        // --- Spiel-Logik ---
        function zeigeSpiel(event) {
            event.preventDefault();
            
            state.gelernteBuchstaben = Array.from(buchstabenContainer.querySelectorAll('input:checked')).map(input => input.value);
            
            let min = parseInt(minSilbenInput.value) || 1;
            let max = parseInt(maxSilbenInput.value) || 3;
            if (min > max) {
                min = max;
                minSilbenInput.value = min;
            }
            state.minSilben = min;
            state.maxSilben = max;

            state.worteProRunde = parseInt(worteProRundeInput.value) || 10;
            state.silbenFaerben = silbenFaerbenCheckbox.checked;
            state.silbenAbstand = silbenAbstandCheckbox.checked;

            state.vokale = state.gelernteBuchstaben.filter(b => VOKAL_LISTE.includes(b));
            state.konsonanten = state.gelernteBuchstaben.filter(b => KONSONANT_LISTE.includes(b));
            state.diphthonge = state.gelernteBuchstaben.filter(b => DIPHTHONGE_LISTE.includes(b));
            
            saveSettings();

            state.aktuellesWortIndex = 0;
            state.richtigGezählt = 0;
            state.gezeigteWorte = [];

            startbildschirm.classList.add('hidden');
            auswertung.classList.add('hidden');
            spiel.classList.remove('hidden');
            spiel.classList.add('flex'); 

            generiereUndZeigeNaechstesWort();
        }

        function handleWort(richtig) {
            if (richtig) {
                state.richtigGezählt++;
            }
            
            if (state.aktuellesWortIndex >= state.worteProRunde) {
                zeigeAuswertung();
            } else {
                generiereUndZeigeNaechstesWort();
            }
        }

        function generiereUndZeigeNaechstesWort() {
            let silben;
            let wortString;
            let versuche = 0;
            const MAX_VERSUCHE = 50; 

            do {
                silben = generiereWort();
                wortString = silben.join('');
                versuche++;
            } while (state.gezeigteWorte.includes(wortString) && versuche < MAX_VERSUCHE);

            state.gezeigteWorte.push(wortString);
            state.aktuellesWort = silben;
            
            displayWort(state.aktuellesWort);
            state.aktuellesWortIndex++;
        }

        /**
         * Zeigt das Wort (als Array von Silben) im Container an
         */
        function displayWort(silbenArray) {
            wortContainer.innerHTML = '';
            
            silbenArray.forEach((silbe, index) => {
                const span = document.createElement('span');
                span.textContent = silbe;
                
                if (state.silbenFaerben) {
                    span.classList.add(index % 2 === 0 ? 'text-blue-600' : 'text-red-600');
                    span.classList.add(index % 2 === 0 ? 'dark:text-blue-400' : 'dark:text-red-400');
                }
                
                if (state.silbenAbstand && index < silbenArray.length - 1) {
                    span.style.marginRight = '0.2em';
                }
                
                wortContainer.appendChild(span);
            });

            adjustFontSize();
        }

        /**
         * Passt die Schriftgröße des Wortes dynamisch an die Containerbreite an.
         */
        function adjustFontSize() {
            if (!wortContainer.offsetParent) {
                return; 
            }

            const container = wortContainer;
            const parent = spiel; 

            const maxFontSize = 4.5; // in rem
            container.style.fontSize = `${maxFontSize}rem`;

            const parentWidth = parent.clientWidth - 48; // p-6 (links/rechts)
            let containerWidth = container.scrollWidth;

            if (containerWidth > parentWidth) {
                let newFontSize = (parentWidth / containerWidth) * maxFontSize;
                newFontSize *= 0.98; 
                if (newFontSize < 1.5) newFontSize = 1.5;
                container.style.fontSize = `${newFontSize}rem`;
            }
        }


        // --- Wort-Generator ---

        /**
         * Wählt ein zufälliges Element aus einem Array aus.
         */
        function randomChoice(arr) {
            if (!arr || arr.length === 0) return null;
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Generiert eine einzelne Silbe
         */
        function generiereSilbe(noSingleVowel = false, forceTwoPlusLetters = false) {
            const k = randomChoice(state.konsonanten);
            const v = randomChoice(state.vokale);
            const d = randomChoice(state.diphthonge);

            const moeglicheSilben = [];

            if (k && v) moeglicheSilben.push(k + v); // "Ma"
            if (d) moeglicheSilben.push(d); // "Ei"
            
            if (!noSingleVowel && !forceTwoPlusLetters && v) {
                moeglicheSilben.push(v); // "O"
            }
            
            if (forceTwoPlusLetters && moeglicheSilben.length === 0 && v && !noSingleVowel) {
                moeglicheSilben.push(v);
            }

            if (moeglicheSilben.length === 0 && state.gelernteBuchstaben.length > 0) {
                 return randomChoice(state.gelernteBuchstaben);
            }

            return randomChoice(moeglicheSilben) || "";
        }


        /**
         * Generiert ein komplettes Wort aus Silben.
         */
        function generiereWort() {
            const min = state.minSilben;
            const max = state.maxSilben;
            const silbenAnzahl = Math.floor(Math.random() * (max - min + 1)) + min;

            const silben = [];
            let letzteSilbeWarEinzelVokal = false;

            if (state.gelernteBuchstaben.length === 0) {
                return ["Bitte", "Buchstaben", "wählen"];
            }
            if (state.vokale.length === 0 && state.diphthonge.length === 0) {
                return ["Bitte", "Vokale", "lernen"];
            }

            for (let i = 0; i < silbenAnzahl; i++) {
                const forceTwoPlus = (state.minSilben === 1 && state.maxSilben === 1 && (state.konsonanten.length > 0 || state.diphthonge.length > 0));
                
                const silbe = generiereSilbe(letzteSilbeWarEinzelVokal, forceTwoPlus);
                
                if (silbe) {
                    silben.push(silbe);
                    letzteSilbeWarEinzelVokal = (silbe.length === 1 && state.vokale.includes(silbe));
                }
            }
            
            if (silben.length === 0) {
                 return [generiereSilbe(false, false)];
            }

            return silben;
        }

        // --- Auswertung ---
        function zeigeAuswertung() {
            const prozentsatz = state.richtigGezählt / state.worteProRunde;
            let sterne = 0;
            if (prozentsatz < 0.2) sterne = 1;
            else if (prozentsatz < 0.4) sterne = 2;
            else if (prozentsatz < 0.7) sterne = 3;
            else if (prozentsatz < 0.9) sterne = 4;
            else sterne = 5;

            sterneBewertung.innerHTML = '★'.repeat(sterne) + '☆'.repeat(5 - sterne);

            spiel.classList.add('hidden');
            spiel.classList.remove('flex');
            auswertung.classList.remove('hidden');
            auswertung.classList.add('flex');
        }

        function zeigeStartbildschirm() {
            auswertung.classList.add('hidden');
            auswertung.classList.remove('flex');
            spiel.classList.add('hidden'); // Sicherstellen, dass Spiel auch ausgeblendet wird
            spiel.classList.remove('flex');
            startbildschirm.classList.remove('hidden');
            startbildschirm.classList.add('flex');
        }

    </script>
</body>
</html>

